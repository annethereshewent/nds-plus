<head>
  <link rel="stylesheet" href="bulma.min.css">
  <link rel="stylesheet" href="app.css">
  <script src="https://kit.fontawesome.com/2c3ddc949d.js" crossorigin="anonymous"></script>
</head>
<body>
  <nav class="navbar is-link">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.github.com/annethereshewent"><i class="fa-brands logo fa-github"></i>NDS Emulator</a>
    </div>

    <div id="navbar-main" class="navbar-menu">
      <div class="navbar-start">
        <div class="navbar-item">
          <div class="buttons">
            <button id="bios7-button" class="button is-warning">
              <i class="fa-solid fa-upload"></i>
              Load Arm7 Bios
            </button>
            <button id="bios9-button" class="button is-warning">
              <i class="fa-solid fa-upload"></i>
              Load Arm9 Bios
            </button>
            <button id="firmware-button" class="button is-warning">
              <i class="fa-solid fa-upload"></i>
              Load Firmware
            </button>
            <button disabled id="game-button" class="button is-primary">
              <i class="fa-solid fa-upload"></i>
              Load Game
            </button>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item">
          <div class="buttons">
            <button class="button is-info" onclick="displayHelpModal()">
              <i class="fa-solid fa-circle-info"></i>
              Help
            </button>
            <button class="button is-danger" onclick="enterFullscreen()">
              <i class="fa-solid fa-expand"></i>
              Full Screen
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <div id="emulator">
    <input type="file" id="bios7-input" class="file-input">
    <input type="file" id="bios9-input" class="file-input">
    <input type="file" id="firmware-input" class="file-input">
    <input type="file" id="game-input" class="file-input">
    <p id="fps-counter"></p>
    <div>
      <canvas width="256" height="192" id="top-canvas" />
    </div>
    <div>
      <canvas width="256" height="192" id="bottom-canvas" />
    </div>
  </div>
  <div id="help-modal" class="modal hide">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="card">
        <header class="card-header">
          <p class="card-header-title">
            NDS Emulator Help
          </p>
        </header>
        <div class="card-content">
          <div class="content">
            <button class="modal-close" aria-label="close" onclick="hideHelpModal()">Close</button>
            <h2>How to use</h2>
            <p>
              You will need copies of the arm7 and arm9 BIOSes, as well as the firmware. Use the proper buttons to load accordingly.
              You will only need to do this once, the BIOS will be saved into local storage for next time you use the emulator.
            </p>
            <h2 class="content-title">Controls</h2>
            <h3>Keyboard:</h3>
            <ul>
              <li><label>Up:</label> W key</li>
              <li><label>Down:</label> S key</li>
              <li><label>Left:</label> A key</li>
              <li><label>Right:</label> D key</li>
              <li><label>A button:</label> L Key</li>
              <li><label>B button:</label> K Key</li>
              <li><label>X button:</label> I Key</li>
              <li><label>Y button:</label> J Key</li>
              <li><label>L button:</label> C Key</li>
              <li><label>R button:</label> V Key</li>
              <li><label>Select:</label> Tab</li>
              <li><label>Start:</label> Enter</li>
            </ul>
            <h3>PS5 Controller:</h3>
            <ul>
              <li><label>Directions:</label> Control pad</li>
              <li><label>A button:</label> Circle button</li>
              <li><label>B button:</label> Cross button</li>
              <li><label>X button:</label> Triangle button</li>
              <li><label>Y button:</label> Square button</li>
              <li><label>L button:</label> L1 button</li>
              <li><label>R button:</label> R1 button</li>
              <li><label>Select:</label> Share</li>
              <li><label>Start:</label> Options</li>
            </ul>

            <p>Emulator written by <a href="https://www.github.com/annethereshewent">annethereshewent</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="bios-notification" class="notification is-primary">
    Loaded file successfully
  </div>
  <script src="jszip.min.js"></script>
  <script>
    function enterFullscreen() {
      document.documentElement.requestFullscreen()
    }
    function displayHelpModal() {
      document.getElementById("help-modal").className = "modal show"
    }

    function hideHelpModal() {
      document.getElementById("help-modal").className = "modal hide"
    }
  </script>
  <script type="module">
    const FPS_INTERVAL = 1000 / 60
    const SAMPLE_RATE = 44100
    const BUFFER_SIZE = 8192
    const SCREEN_WIDTH = 256
    const SCREEN_HEIGHT = 192

    import init, { WasmEmulator, ButtonEvent } from "./pkg/ds_emulator_wasm.js"

    async function main() {

      let emulator = null
      let biosData7 = null
      let biosData9 = null
      let firmware = null
      let fileName = ""
      let gameData = null

      const keyboardButtons = []

      // let biosJson = JSON.parse(localStorage.getItem("bios"))

      // if (biosJson != null) {
      //   biosData = new Uint8Array(biosJson)
      //   document.getElementById("game-button").removeAttribute("disabled")
      //   document.getElementById("bios-button").setAttribute("disabled", "true")

      //   const biosNotification = document.getElementById("bios-notification")

      //   biosNotification.style.display = "block"

      //   let opacity = 1.0

      //   let interval = setInterval(() => {
      //     opacity -= 0.1

      //     biosNotification.style.opacity = opacity

      //     if (opacity <= 0) {
      //       clearInterval(interval)
      //     }
      //   }, 100)
      // }

      const bios7Json = JSON.parse(localStorage.getItem("ds_bios7"))
      const bios9Json = JSON.parse(localStorage.getItem("ds_bios9"))
      const firmwareJson = JSON.parse(localStorage.getItem("ds_firmware"))

      if (bios7Json != null) {
        biosData7 = new Uint8Array(bios7Json)
      }

      if (bios9Json != null) {
        biosData9 = new Uint8Array(bios9Json)
      }

      if (firmwareJson != null) {
        firmware = new Uint8Array(firmwareJson)
      }

      console.log(bios7Json)
      console.log(bios9Json)
      console.log(firmware)

      if (biosData7 != null && biosData9 != null && firmware != null) {
        document.getElementById("game-button").removeAttribute("disabled")
        document.getElementById("bios9-button").setAttribute("disabled", "true")
        document.getElementById("bios7-button").setAttribute("disabled", "true")
        document.getElementById("firmware-button").setAttribute("disabled", "true")
      }

      document.getElementById("bios7-button").addEventListener("click", () => document.getElementById("bios7-input").click())
      document.getElementById("bios9-button").addEventListener("click", () => document.getElementById("bios9-input").click())
      document.getElementById("firmware-button").addEventListener("click", () => document.getElementById("firmware-input").click())
      document.getElementById("game-button").addEventListener("click", () => document.getElementById("game-input").click())

      document.getElementById("bios7-input").addEventListener("change", handleBios7Change)
      document.getElementById("bios9-input").addEventListener("change", handleBios9Change)
      document.getElementById("firmware-input").addEventListener("change", handleFirmwareChange)
      document.getElementById("game-input").addEventListener("change", handleGameChange)

      const path = "pkg/ds_emulator_wasm_bg.wasm"

      const wasm = await init(path)

      const topCanvas = document.getElementById("top-canvas")
      const topContext = topCanvas.getContext("2d")

      const bottomCanvas = document.getElementById("bottom-canvas")
      const bottomContext = bottomCanvas.getContext("2d")

      const analogModeStatus = document.getElementById("analog-mode-status")
      const analogIcon = document.getElementById("analog-mode-status-icon")

      async function handleFileChange(e) {
        let fileData = null
        const data = await getBinaryData(e)

        if (data != null) {
          fileData = new Uint8Array(data)

          const fileNotification = document.getElementById("bios-notification")

          fileNotification.style.display = "block"

          let opacity = 1.0

          let interval = setInterval(() => {
            opacity -= 0.1

            fileNotification.style.opacity = opacity

            if (opacity <= 0) {
              clearInterval(interval)
            }
          }, 100)
        }

        return fileData
      }

      async function handleBios7Change(e) {
        biosData7 = await handleFileChange(e)

        localStorage.setItem("ds_bios7", JSON.stringify(Array.from(biosData7)))

        if (biosData7 != null && biosData9 != null && firmware != null) {
          document.getElementById("game-button").removeAttribute("disabled")
          document.getElementById("bios9-button").setAttribute("disabled", "true")
          document.getElementById("bios7-button").setAttribute("disabled", "true")
          document.getElementById("firmware-button").setAttribute("disabled", "true")
        }
      }

      async function handleBios9Change(e) {
        biosData9 = await handleFileChange(e)

        localStorage.setItem("ds_bios9", JSON.stringify(Array.from(biosData9)))

        if (biosData7 != null && biosData9 != null && firmware != null) {
          document.getElementById("game-button").removeAttribute("disabled")
          document.getElementById("bios9-button").setAttribute("disabled", "true")
          document.getElementById("bios7-button").setAttribute("disabled", "true")
          document.getElementById("firmware-button").setAttribute("disabled", "true")
        }
      }

      async function handleFirmwareChange(e) {
        firmware = await handleFileChange(e)

        localStorage.setItem("ds_firmware", JSON.stringify(Array.from(firmware)))

        if (biosData7 != null && biosData9 != null && firmware != null) {
          document.getElementById("game-button").removeAttribute("disabled")
          document.getElementById("bios9-button").setAttribute("disabled", "true")
          document.getElementById("bios7-button").setAttribute("disabled", "true")
          document.getElementById("firmware-button").setAttribute("disabled", "true")
        }
      }

      async function handleGameChange(e) {
        const game = await getBinaryData(e)

        if (game != null) {
          gameData = new Uint8Array(game)

          emulator = new WasmEmulator(biosData7, biosData9, firmware, gameData)

          startAudio()

          requestAnimationFrame((time) => run(time))
        }
      }

      function startAudio() {
        const audioContext = new AudioContext({ sampleRate: SAMPLE_RATE })

        const scriptProcessor = audioContext.createScriptProcessor(BUFFER_SIZE, 0, 2)

        scriptProcessor.onaudioprocess = (e) => {
          const leftData = e.outputBuffer.getChannelData(0)
          const rightData = e.outputBuffer.getChannelData(1)

          emulator.update_audio_buffers(leftData, rightData)
        }

        scriptProcessor.connect(audioContext.destination)
      }

      const CROSS_BUTTON = 0
      const CIRCLE_BUTTON = 1
      const SQUARE_BUTTON = 2
      const TRIANGLE_BUTTON = 3

      const L1_BUTTON = 4
      const R1_BUTTON = 5

      const SELECT = 8
      const START = 9

      const UP = 12
      const DOWN = 13
      const LEFT = 14
      const RIGHT = 15

      let switchingDigitalMode = false
      function handleJoypadInput() {
        const gamepad = navigator.getGamepads()[0]

        emulator.update_input(ButtonEvent.ButtonSelect, gamepad?.buttons[SELECT].pressed == true || keyboardButtons[SELECT], false)
        emulator.update_input(ButtonEvent.ButtonStart, gamepad?.buttons[START].pressed == true || keyboardButtons[START], false)
        emulator.update_input(Buttonevent.ButtonUp, gamepad?.buttons[UP].pressed == true || keyboardButtons[UP], false)
        emulator.update_input(Buttonevent.ButtonRight, gamepad?.buttons[RIGHT].pressed == true || keyboardButtons[RIGHT], false)
        emulator.update_input(Buttonevent.ButtonDown, gamepad?.buttons[DOWN].pressed == true || keyboardButtons[DOWN], false)
        emulator.update_input(Buttonevent.ButtonLeft, gamepad?.buttons[LEFT].pressed == true || keyboardButtons[LEFT], false)
        emulator.update_input(Buttonevent.ButtonL1, gamepad?.buttons[L1_BUTTON].pressed == true || keyboardButtons[L1_BUTTON], true)
        emulator.update_input(Buttonevent.ButtonR1, gamepad?.buttons[R1_BUTTON].pressed == true || keyboardButtons[R1_BUTTON], true)
        emulator.update_input(Buttonevent.ButtonTriangle, gamepad?.buttons[TRIANGLE_BUTTON].pressed == true || keyboardButtons[TRIANGLE_BUTTON], true)
        emulator.update_input(Buttonevent.ButtonCircle, gamepad?.buttons[CIRCLE_BUTTON].pressed == true || keyboardButtons[CIRCLE_BUTTON], true)
        emulator.update_input(Buttonevent.ButtonCross, gamepad?.buttons[CROSS_BUTTON].pressed == true || keyboardButtons[CROSS_BUTTON], true)
        emulator.update_input(Buttonevent.ButtonSquare, gamepad?.buttons[SQUARE_BUTTON].pressed == true || keyboardButtons[SQUARE_BUTTON], true)
      }

      function updatePicture(pointer, currentContext) {
        const engineBuffer = new Uint8Array(wasm.memory.buffer, pointer)

        const imageData = currentContext.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT)

        for (let y = 0; y < SCREEN_HEIGHT; y++) {
          for (let x = 0; x < SCREEN_WIDTH; x++) {
            const rustIndex = x * 3 + y * 3 * SCREEN_WIDTH
            const imageIndex = x * 4 + y * 4 * SCREEN_WIDTH

            imageData.data[imageIndex] = engineBuffer[rustIndex]
            imageData.data[imageIndex+1] = engineBuffer[rustIndex+1]
            imageData.data[imageIndex+2] = engineBuffer[rustIndex+2]
            imageData.data[imageIndex+3] = 255
          }
        }

        currentContext.putImageData(imageData, 0, 0)
      }

      let previousTime = 0
      let realPreviousTime = 0
      let frames = 0
      async function run(time) {
        const diff = time - previousTime
        const realDiff = time - realPreviousTime

        if (frames == 60) {
          frames = 0
          document.getElementById("fps-counter").innerHTML = `FPS = ${1000 / diff}`
        }

        realPreviousTime = time

        if (diff >= FPS_INTERVAL || previousTime == 0) {
          emulator.step_frame()

          frames++
          previousTime = time - (diff % FPS_INTERVAL)

          // handleJoypadInput()

          let topPointer = null
          let bottomPointer = null

          if (emulator.is_top_a()) {
            topPointer = emulator.get_engine_a_picture_pointer()
            bottomPointer = emulator.get_engine_b_picture_pointer()
          } else {
            topPointer = emulator.get_engine_b_picture_pointer()
            bottomPointer = emulator.get_engine_a_picture_pointer()
          }
          updatePicture(topPointer, topContext)
          updatePicture(bottomPointer, bottomContext)
        }

        requestAnimationFrame((time) => run(time))
      }

      async function getBinaryData(e, setFilename) {
        let data = null
        if (e.target.files != null) {
          const file = e.target.files[0]

          if (setFilename) {
            fileName = file.name
          }
          if (file.name.indexOf(".zip") !== -1) {
            // unzip the file first
            const zipFile = await JSZip.loadAsync(file)
            const zipFileName = Object.keys(zipFile.files)[0]

            data = await zipFile?.file(zipFileName)?.async('arraybuffer')
          } else {
            data = await fileToArrayBuffer(file)
          }
        }

        return data
      }

      function fileToArrayBuffer(file){
        const fileReader = new FileReader()

        return new Promise((resolve, reject) => {
          fileReader.onload = () => resolve(fileReader.result)

          fileReader.onerror = () => {
            fileReader.abort()
            reject(new Error("Error parsing file"))
          }

          fileReader.readAsArrayBuffer(file)
        })
      }

      document.addEventListener("keydown", (e) => {
        e.preventDefault()

        switch (e.key) {
          case "Escape":
            document.getElementById("help-modal").className = "modal hide"
            break
          case "w":
            keyboardButtons[UP] = true
            break
          case "a":
            keyboardButtons[LEFT] = true
            break
          case "s":
            keyboardButtons[DOWN] = true
            break
          case "d":
            keyboardButtons[RIGHT] = true
            break
          case "k":
            keyboardButtons[CROSS_BUTTON] = true
            break
          case "l":
            keyboardButtons[CIRCLE_BUTTON] = true
            break
          case "j":
            keyboardButtons[SQUARE_BUTTON] = true
            break
          case "i":
            keyboardButtons[TRIANGLE_BUTTON] = true
            break
          case "c":
            keyboardButtons[L1_BUTTON] = true
            break
          case "v":
            keyboardButtons[R1_BUTTON] = true
            break
        }
      })

      document.addEventListener("keyup", (e) => {
        e.preventDefault()

        switch (e.key) {
          case "Escape":
            document.getElementById("help-modal").className = "modal hide"
            break
          case "w":
            keyboardButtons[UP] = false
            break
          case "a":
            keyboardButtons[LEFT] = false
            break
          case "s":
            keyboardButtons[DOWN] = false
            break
          case "d":
            keyboardButtons[RIGHT] = false
            break
          case "k":
            keyboardButtons[CROSS_BUTTON] = false
            break
          case "l":
            keyboardButtons[CIRCLE_BUTTON] = false
            break
          case "j":
            keyboardButtons[SQUARE_BUTTON] = false
            break
          case "i":
            keyboardButtons[TRIANGLE_BUTTON] = false
            break
          case "c":
            keyboardButtons[L1_BUTTON] = false
            break
          case "v":
            keyboardButtons[R1_BUTTON] = false
            break
          case "z":
            keyboardButtons[L2_BUTTON] = false
            break
          case "x":
            keyboardButtons[R2_BUTTON] = false
            break
          case "1":
            keyboardButtons[L3_BUTTON] = false
            break
          case "2":
            keyboardButtons[R3_BUTTON] = false
            break
        }
      })
    }

    main()
  </script>
</body>